name: GAUwallet CI/CD

on:
  # Automatic: Run on every push to main
  push:
    branches: [ main ]

  # Manual triggers with action selection
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - 'integration-tests'
          - 'build-android'
          - 'build-ios'

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ============================================
  # AUTOMATIC: Run on every push to main
  # ============================================
  analyze-and-test:
    name: Analyze and Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Run flutter analyze
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: ğŸ§ª Run unit tests (exclude integration)
        run: flutter test --exclude-tags=integration

      - name: ğŸ”¨ Build Android AAB (debug - verification only)
        run: flutter build appbundle --debug

      - name: âœ… Success
        run: |
          echo "âœ“ Flutter analyze passed"
          echo "âœ“ Unit tests passed"
          echo "âœ“ Android build verified"

  # ============================================
  # AUTOMATIC: Deploy Web to Vercel
  # ============================================
  deploy-web:
    name: Deploy Web to Vercel
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'push'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Flutter Web (Release)
        run: flutter build web --release

      - name: ğŸ“¦ Install Vercel CLI
        run: npm install -g vercel

      - name: ğŸš€ Deploy to Vercel (Production)
        run: |
          cd build/web
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ secrets.VERCEL_ORG_ID }} \
            --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: âœ… Deployment Complete
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… WEB APP DEPLOYED TO VERCEL SUCCESSFULLY             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Production URL: https://wallet-v2.vercel.app"
          echo "   (or your custom domain if configured)"

  # ============================================
  # MANUAL: Integration Tests (Mainnet)
  # ============================================
  integration-tests:
    name: Integration Tests - Production Backend
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'integration-tests'
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš ï¸ Mainnet Warning
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš ï¸  WARNING: Running tests on PRODUCTION mainnet       â•‘"
          echo "â•‘  This will cost real gas (~$0.02-0.05 total)           â•‘"
          echo "â•‘  Backend: https://metatx.vercel.app                    â•‘"
          echo "â•‘  RelayerV4: 0xA7E2f9aF0023CF4558Baac747Dd01179297dDE8D â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”¥ Run Critical Path Tests
        run: flutter test test/integration/critical_path_test.dart

      - name: âœ… Integration Tests Passed
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… ALL INTEGRATION TESTS PASSED                        â•‘"
          echo "â•‘  Production backend is READY for deployment             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # ============================================
  # MANUAL: Build Android Release AAB
  # ============================================
  build-android:
    name: Build Android Release AAB
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'build-android'
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build Release AAB
        run: flutter build appbundle --release

      - name: ğŸ“¤ Upload Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release.aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 90

      - name: ğŸš€ Upload to Google Play (Internal Track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.gaugecash.wallet
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed

      - name: âœ… Build Complete
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… ANDROID RELEASE AAB BUILT SUCCESSFULLY              â•‘"
          echo "â•‘  âœ… UPLOADED TO GOOGLE PLAY (INTERNAL TRACK)            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ AAB file location:"
          echo "   build/app/outputs/bundle/release/app-release.aab"
          echo ""
          echo "ğŸš€ Deployed to:"
          echo "   - Google Play Console (Internal Testing)"
          echo "   - GitHub Actions Artifacts (90 day retention)"
          echo ""
          echo "ğŸ“ Next steps:"
          echo "   1. Go to Google Play Console"
          echo "   2. Review the internal release"
          echo "   3. Promote to production when ready"

  # ============================================
  # MANUAL: Build iOS Release IPA
  # ============================================
  build-ios:
    name: Build iOS Release IPA
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'build-ios'
    timeout-minutes: 45

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ”¨ Build IPA (no codesign)
        run: flutter build ipa --release --no-codesign

      - name: ğŸ“¤ Upload Build Output
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-output
          path: build/ios/
          retention-days: 30

      - name: ğŸ“ Codesigning Instructions
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… iOS BUILD SUCCESSFUL (unsigned)                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  NOTE: This build is NOT signed."
          echo ""
          echo "To enable automatic signing, configure these secrets:"
          echo "   - APPLE_CERTIFICATE (base64 encoded .p12)"
          echo "   - APPLE_CERTIFICATE_PASSWORD"
          echo "   - PROVISIONING_PROFILE (base64 encoded .mobileprovision)"
          echo ""
          echo "Or manually sign with Xcode:"
          echo "   1. Open build/ios/archive/*.xcarchive in Xcode"
          echo "   2. Distribute to App Store"
          echo "   3. Sign with your Apple Developer account"

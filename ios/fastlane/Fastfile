# Fastfile for GAUGECASH iOS Deployment

default_platform(:ios)

platform :ios do
  before_all do
    # Configure App Store Connect API Key for all actions (MUST BE FIRST)
    if ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
      app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_CONTENT"],
        is_key_content_base64: true,
        in_house: false
      )
    end

    setup_ci if is_ci
  end

  desc "Build iOS app"
  lane :build do
    # ... previous code remains the same ...
  end

  desc "Build and sign iOS app"
  lane :build_signed do
    # 1. Get certificates and profiles using Match
    # (setup_ci and api_key are already handled by before_all)
    match(
      type: "appstore",
      readonly: true, # Strictly readonly in CI
      app_identifier: "com.gaugecash.app",
      git_url: ENV["MATCH_GIT_URL"] || "git@github.com:gaugecash/ios-certificates.git"
    )

    # 2. Update project settings to use Match certificates
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Runner.xcodeproj",
      team_id: "MG9USD9QPW",
      bundle_identifier: "com.gaugecash.app",
      profile_name: "match AppStore com.gaugecash.app",
      code_sign_identity: "Apple Distribution"
    )

    # 3. Build Flutter app (unsigned)
    sh("cd ../.. && flutter clean")
    sh("cd ../.. && flutter pub get")
    cocoapods(clean_install: true, podfile: "./Podfile")
    sh("cd ../.. && flutter build ios --release --no-codesign")

    # 4. Build signed IPA with Xcode
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      configuration: "Release",
      clean: false,
      output_directory: "./build",
      output_name: "GAUGECASH.ipa"
    )

    UI.success("Signed build completed!")
  end

  desc "Deploy to TestFlight"
  lane :beta do
    # Build and sign
    build_signed

    # Upload to TestFlight
    # (API key is already configured in before_all)
    upload_to_testflight(
      skip_waiting_for_build_processing: false,
      skip_submission: false
    )

    UI.success("Successfully uploaded to TestFlight!")
  end

  desc "Deploy to App Store"
  lane :release do
    # Build and sign
    build_signed

    # Upload to App Store and submit for review
    # (API key is already configured in before_all)
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      skip_binary_upload: false,
      submit_for_review: true,
      automatic_release: true,
      force: true
    )

    UI.success("Successfully uploaded to App Store and submitted for review!")
  end

  desc "Setup code signing with Match"
  lane :setup_signing do
    match(
      type: "appstore",
      app_identifier: "com.gaugecash.app",
      readonly: false
    )
  end
end
